<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ... head unchanged ... -->
</head>
<body>
  <header class="header-bar">
    <a href="index.html"><img src="assets/logo1.png" alt="LookList Logo" class="logo-img" /></a>
    <span class="header-title">LookList <span data-auth="user-name" class="user-greeting" hidden></span></span>
    <a href="index.html" class="home-link hide-mobile">Home</a>
    <a href="services.html" class="home-link nav-desktop">Services</a>
    <a href="messages.html" class="home-link nav-desktop">Messages</a>
    <a href="profile.html" class="home-link nav-desktop">Profile</a>
    <a href="signin.html" class="home-link nav-desktop" data-auth="signin" aria-current="page">Sign in</a>
    <a href="services.html" class="home-link show-mobile">Services</a>
    <a href="messages.html" class="home-link show-mobile">Messages</a>
    <a href="profile.html" class="home-link show-mobile">Profile</a>
    <a href="signin.html" class="home-link show-mobile" data-auth="signin" aria-current="page">Sign in</a>
  </header>

  <!-- ... main content unchanged ... -->

  <footer>
    <!-- ... footer unchanged ... -->
  </footer>

  <nav class="mobile-bottom-nav" aria-label="Primary">
    <a class="nav-item" href="index.html">
      <img class="nav-icon" src="assets/home.png" alt="" aria-hidden="true" />
      <span class="nav-label">Home</span>
    </a>
    <a class="nav-item" href="services.html">
      <img class="nav-icon" src="assets/service.png" alt="" aria-hidden="true" />
      <span class="nav-label">Services</span>
    </a>
    <a class="nav-item" href="messages.html">
      <img class="nav-icon" src="assets/messages.png" alt="" aria-hidden="true" />
      <span class="nav-label">Messages</span>
    </a>
    <a class="nav-item" href="profile.html">
      <img class="nav-icon" src="assets/profile.png" alt="" aria-hidden="true" />
      <span class="nav-label">Profile</span>
    </a>
    <a class="nav-item" href="signin.html" data-auth="signin" aria-current="page">
      <img class="nav-icon" src="assets/profile.png" alt="" aria-hidden="true" />
      <span class="nav-label">Sign in</span>
    </a>
  </nav>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js"></script>
  <script>
    // Helper: next= redirect target after auth
    function getNextUrl() {
      const p = new URLSearchParams(location.search);
      return p.get('next') || 'profile.html';
    }

    (async function init() {
      try {
        if (window.authInit) {
          const { user } = await window.authInit();
          const signInLinks = document.querySelectorAll('[data-auth="signin"]');
          if (user) {
            signInLinks.forEach(el => {
              el.textContent = 'Sign Out';
              el.onclick = (e) => { e.preventDefault(); authSignOut(); };
              el.setAttribute('href', '#');
            });
          } else {
            signInLinks.forEach(el => {
              el.textContent = 'Sign in';
              el.onclick = null;
              el.setAttribute('href', 'signin.html');
            });
          }
        }
      } catch (e) { console.warn('Auth init warning:', e); }
      setActiveTab('signin');
    })();

    // Tabs
    const tabSignin = document.getElementById('tab-signin');
    const tabSignup = document.getElementById('tab-signup');
    const panelSignin = document.getElementById('panel-signin');
    const panelSignup = document.getElementById('panel-signup');
    function setActiveTab(tab) {
      const isSignin = tab === 'signin';
      tabSignin.setAttribute('aria-selected', String(isSignin));
      tabSignup.setAttribute('aria-selected', String(!isSignin));
      panelSignin.hidden = !isSignin;
      panelSignup.hidden = isSignin;
      (isSignin ? document.getElementById('signin-email') : document.getElementById('signup-name')).focus();
    }
    tabSignin.addEventListener('click', () => setActiveTab('signin'));
    tabSignup.addEventListener('click', () => setActiveTab('signup'));
    document.getElementById('go-signup')?.addEventListener('click', (e) => { e.preventDefault(); setActiveTab('signup'); });
    document.getElementById('go-signin')?.addEventListener('click', (e) => { e.preventDefault(); setActiveTab('signin'); });

    // Choose client based on "Remember me"
    function activeClient(remember) {
      return remember ? window.authClients.spLocal : window.authClients.spSession;
    }
    function persistentClient() { return window.authClients.spLocal; }

    window.authClients.spLocal.auth.onAuthStateChange((_e, session) => { if (session) window.location.replace(getNextUrl()); });
    window.authClients.spSession.auth.onAuthStateChange((_e, session) => { if (session) window.location.replace(getNextUrl()); });

    // Sign In (Supabase)
    document.getElementById('signin-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('signin-email').value.trim().toLowerCase();
      const password = document.getElementById('signin-password').value;
      const remember = document.getElementById('remember-me').checked;

      const emailErr = document.getElementById('signin-email-error');
      const passErr = document.getElementById('signin-password-error');
      const status = document.getElementById('signin-status');

      emailErr.hidden = true; emailErr.textContent = '';
      passErr.hidden = true; passErr.textContent = '';
      status.textContent = '';

      let ok = true;
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { emailErr.hidden = false; emailErr.textContent = 'Enter a valid email.'; ok = false; }
      if (!password) { passErr.hidden = false; passErr.textContent = 'Enter your password.'; ok = false; }
      if (!ok) return;

      try {
        const { error } = await activeClient(remember).auth.signInWithPassword({ email, password });
        if (error) throw error;
        status.innerHTML = '<span class="success">Signed in! Redirecting…</span>';
        setTimeout(() => { window.location.replace(getNextUrl()); }, 400);
      } catch (err) {
        status.innerHTML = `<span class="error">${err?.message || 'Sign in failed'}</span>`;
      }
    });

    // Sign Up (Supabase) – stores "name" in user metadata
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('signup-email').value.trim().toLowerCase();
      const password = document.getElementById('signup-password').value;
      const name = document.getElementById('signup-name').value.trim();
      const confirm = document.getElementById('signup-confirm').value;
      const terms = document.getElementById('signup-terms').checked;

      const status = document.getElementById('signup-status');
      status.textContent = '';

      if (password !== confirm) {
        status.innerHTML = '<span class="error">Passwords do not match.</span>';
        return;
      }
      if (!terms) {
        status.innerHTML = '<span class="error">You must accept the Terms.</span>';
        return;
      }

      try {
        const { error } = await persistentClient().auth.signUp({
          email,
          password,
          options: { data: { name } }   // stores "name" in user metadata
        });
        if (error) throw error;
        status.innerHTML = '<span class="success">Check your email to confirm your account!</span>';
      } catch (err) {
        status.innerHTML = `<span class="error">${err?.message || 'Sign up failed'}</span>`;
      }
    });
  </script>
</body>
</html>